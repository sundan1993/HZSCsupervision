<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>编辑管理员</title>
<link rel="stylesheet" type="text/css" href="css/common.css"/>
<link rel="stylesheet" type="text/css" href="css/login.css">
<script typet="text/javascript" src="http://libs.baidu.com/jquery/1.9.1/jquery.min.js"></script>
</head>
<body>
	<div id="banner"></div>
	<div id="top-nav">
		<div class="Rw">
			<img src="img/logo.png"/>
			<ul class="top-nav__list Fr">
				<li><a href="outer-map.html">返回首页</a></li>
				<li><a href="sblist.html">设备列表</a></li>
				<li><a href="editgly.html" class="act">编辑管理员</a></li>
				<li><a href="login.html">员工登陆</a></li>
				<li><a onclick="dologout();">退出登录</a></li>
			</ul>
		</div>
	</div>

	<div class="Rw">
		<section id="glyedit-box">
			<div class="box">
				<h1 class='form-title'>添加管理员</h1>
				<input id='adminuser' type='text' class="form-control" placeholder="账号"/>
				<input id='password' type='text' class="form-control" placeholder="密码"/>
				<input id='repassword' type='text' class="form-control" placeholder="重复密码"/>
				<input id='realname' type='text' class="form-control" placeholder="真实姓名"/>
				<button onclick="doadd();" class="form-btn">提交</button>
			</div>

			<div class="box">
				<h1 class='form-title'>编辑管理员权限</h1>
				<ul>
					<li class="form-row">
						<label class="form-label">选择管理员：</label>
						<select id='select1' onchange="getvalue(this)" class="form-control form-control-half">
							<option value=''>请选择</option>
						</select>
						<input type='hidden' id='adminid' value=''/> <!--管理员id，调试完成后设隐藏-->
					</li>
					<li id='roles'>

					</li>
					<li>
						<button onclick="editrole()" class="form-btn-sm">确认修改</button>
						<button onclick="dele()" class="form-btn-sm">删除管理员</button>
					</li>
				</ul>
			</div>
		</section>
	</div>
</body>

<script>

$(function(){ 
	$.ajax({
	    type: "post",
	    url: "http://huhuajian.pe.hu/public/index.php/index/login/get_admin_list",
	    dataType: "jsonp",
	    jsonp: "callback",
	    jsonpCallback: "hel",
	    success: function(data) {
	        for (var i = 0; i < data.data.length; i++) {
	            document.getElementById("select1").options.add(new Option(data.data[i].username + '-' + data.data[i].real_name, data.data[i].id))
	        }
	        console.log(data)
	    },
	    error: function() {
	    	alert('服务器繁忙，请稍后再试。');
	    }
	});	
}); 

function doadd(){
	var username = $('#adminuser').val();
	var password = $('#password').val();
	var repassword = $('#repassword').val();
	var realname = $('#realname').val();
	if(password != repassword){
		alert('两次输入的密码不一致');
		return
	}
	$.ajax({
	    type : "post",
	    url : "http://huhuajian.pe.hu/public/index.php/index/login/addadmin",
	    dataType : "jsonp",
	    jsonp: "callback",
	    jsonpCallback:"adi",
	    data:{adminuser:username,password:password,realname:realname},
	    success : function(data){
	        alert(data.message);
	        location.reload(); 
	    },
	    error:function(){
	    	alert('服务器繁忙，请稍后再试。');
	    }
	});
}

function getvalue(obj){
	//获取value
    var adminid = obj.options[obj.selectedIndex].value
    if(adminid == ''){
    	$('#adminid').val('');
    	$("#roles").empty();
    	return
    }
  	//获取文本
    //var n=obj.options[obj.selectedIndex].text
    //alert(n);
	var obj = document.getElementById("roles");
  	var ht = [];
    $.ajax({
	    type : "get",
	    url : "http://huhuajian.pe.hu/public/index.php/index/login/get_admin_info",
	    dataType : "jsonp",
	    jsonp: "callback",
	    jsonpCallback:"gval",
	    data:{id:adminid},
	    success : function(data){
	    	$("#roles").empty();
	    	var tableDatas = data.data.regioninfo;
	        for(var i=0;i<tableDatas.length;i++){  
	        	var ifcheck = tableDatas[i].ischeck;
	        	var html = "<input value="+tableDatas[i].reid;
				        	if(ifcheck == 1){
			                	html = html+" checked ";
			                } 
				        	html = html+" type='checkbox' name='rule'/>"
		                    +tableDatas[i].name
		                    +"<br/>";
	            $("#roles").append(html);
	        }
	        $('#adminid').val(data.data.admininfo.adminid);
	    	console.log(data);
	    },
	    error:function(){
	    	alert('服务器繁忙，请稍后再试。');
	    }
	});
}

function editrole(){
	var chk_value = []; 
	var adminid = $('#adminid').val();
	$('input[name="rule"]:checked').each(function(){ 
		chk_value.push($(this).val()); 
	}); 
	chk_value = chk_value+',';
	$.ajax({
	    type : "post",
	    url : "http://huhuajian.pe.hu/public/index.php/index/login/edit_role",
	    dataType : "jsonp",
	    jsonp: "callback",
	    jsonpCallback:"edr",
	    data:{adminid:adminid,roles:chk_value},
	    success : function(data){
	        alert(data.message);
	        location.reload(); 
	    },
	    error:function(){
	    	alert('服务器繁忙，请稍后再试。');
	    }
	});
}

function dele(){
	if (confirm("你确定要删除该管理员吗？")){ 
		var adminid = $('#adminid').val();
		$.ajax({
		    type : "post",
		    url : "http://huhuajian.pe.hu/public/index.php/index/login/dele_admin",
		    dataType : "jsonp",
		    jsonp: "callback",
		    jsonpCallback:"dela",
		    data:{adminid:adminid},
		    success : function(data){
		        alert(data.message);
		        location.reload(); 
		    },
		    error:function(){
		    	alert('服务器繁忙，请稍后再试。');
		    }
		});
	} 
}

function dologout(){
	$.ajax({
	    type : "post",
	    url : "http://huhuajian.pe.hu/public/index.php/index/login/logout",
	    dataType : "jsonp",
	    jsonp: "callback",
	    jsonpCallback:"logout",
	    success : function(data){
	        alert(data.message);
	    },
	    error:function(){
	    	alert('服务器繁忙，请稍后再试。');
	    }
	});
}

</script>

</html>